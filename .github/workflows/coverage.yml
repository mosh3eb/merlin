name: Coverage Report

on:
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=merlin --cov-report=xml --cov-report=json --cov-report=term-missing
    
    - name: Parse coverage report
      run: |
        # Extract coverage percentage from pytest-cov output
        pytest tests/ --cov=merlin --cov-report=term-missing --cov-report=xml | tee coverage_output.txt
        
        # Extract coverage percentage from output
        COVERAGE=$(grep "TOTAL" coverage_output.txt | awk '{print $4}' | sed 's/%//')
        echo "COVERAGE_PERCENT=$COVERAGE" >> $GITHUB_ENV
        
        # Save coverage for comment
        echo "Overall coverage: $COVERAGE%" > coverage_summary.txt
        
        # Check if coverage meets 80% threshold
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          echo "STATUS=✅ Meeting target" >> $GITHUB_ENV
          echo "EMOJI=✅" >> $GITHUB_ENV
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          echo "STATUS=⚠️ Below target" >> $GITHUB_ENV
          echo "EMOJI=⚠️" >> $GITHUB_ENV
        else
          echo "STATUS=❌ Well below target" >> $GITHUB_ENV
          echo "EMOJI=❌" >> $GITHUB_ENV
        fi
    
    - name: Generate diff coverage
      run: |
        # Get list of changed files in this PR
        git diff --name-only origin/main...HEAD | grep '\.py$' > changed_files.txt || echo "No Python files changed"
        
        # Calculate coverage only for changed files if any exist
        if [ -s changed_files.txt ]; then
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          cat changed_files.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Simple diff coverage calculation using coverage.xml
          python3 << 'EOF' >> diff_cov_output.txt
          import xml.etree.ElementTree as ET
          import os

          try:
              # Parse coverage.xml
              tree = ET.parse('coverage.xml')
              root = tree.getroot()
              
              # Get changed files
              changed_files = []
              if os.path.exists('changed_files.txt'):
                  with open('changed_files.txt', 'r') as f:
                      changed_files = [line.strip() for line in f if line.strip()]
              
              if changed_files:
                  total_lines = 0
                  covered_lines = 0
                  
                  # Find coverage for each changed file
                  for package in root.findall('.//package'):
                      for class_elem in package.findall('classes/class'):
                          filename = class_elem.get('filename', '')
                          # Match changed files with coverage data
                          for changed_file in changed_files:
                              if changed_file.endswith(filename) or filename.endswith(changed_file):
                                  lines_elem = class_elem.find('lines')
                                  if lines_elem is not None:
                                      for line in lines_elem.findall('line'):
                                          total_lines += 1
                                          if line.get('hits', '0') != '0':
                                              covered_lines += 1
                  
                  if total_lines > 0:
                      diff_coverage = (covered_lines / total_lines) * 100
                      print(f'DIFF_COVERAGE={diff_coverage:.1f}')
                  else:
                      print('DIFF_COVERAGE=N/A')
              else:
                  print('DIFF_COVERAGE=N/A')
                  
          except Exception as e:
              print('DIFF_COVERAGE=N/A')
          EOF
          
          # Extract diff coverage
          DIFF_COV=$(grep "DIFF_COVERAGE=" diff_cov_output.txt | cut -d'=' -f2)
          echo "DIFF_COVERAGE_PERCENT=$DIFF_COV" >> $GITHUB_ENV
        else
          echo "DIFF_COVERAGE_PERCENT=N/A" >> $GITHUB_ENV
        fi
    
    - name: Generate coverage summary for display
      run: |
        echo "## ${EMOJI} Coverage Summary" > coverage_summary.md
        echo "**Overall Coverage:** ${COVERAGE_PERCENT}%" >> coverage_summary.md
        echo "**Status:** ${STATUS}" >> coverage_summary.md
        if [ "$DIFF_COVERAGE_PERCENT" != "N/A" ]; then
          echo "**Changes Coverage:** ${DIFF_COVERAGE_PERCENT}%" >> coverage_summary.md
        fi
        echo "---" >> coverage_summary.md
        echo "*Target: 80% (informational only) | Generated using pytest-cov*" >> coverage_summary.md
        
        # Display in job output
        echo "=== COVERAGE REPORT ==="
        cat coverage_summary.md
        echo "======================="
    
    - name: Comment PR with coverage  
      uses: actions/github-script@v6
      if: github.event.pull_request.head.repo.full_name == github.repository
      continue-on-error: true
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          const coverage = process.env.COVERAGE_PERCENT || '0';
          const status = process.env.STATUS || '❌ Unknown';
          const emoji = process.env.EMOJI || '❌';
          const diffCoverage = process.env.DIFF_COVERAGE_PERCENT || 'N/A';
          
          let diffSection = '';
          if (diffCoverage !== 'N/A') {
            const diffEmoji = parseFloat(diffCoverage) >= 80 ? '✅' : parseFloat(diffCoverage) >= 60 ? '⚠️' : '❌';
            diffSection = `
          ### Changes Coverage ${diffEmoji}
          - **Modified Files Coverage:** ${diffCoverage}%
          - **Status:** ${parseFloat(diffCoverage) >= 80 ? 'Good coverage on changes' : 'Consider adding tests for new code'}`;
          }
          
          const comment = `## ${emoji} Coverage Report
          
          **Overall Coverage:** ${coverage}%
          ${diffSection}
          
          ### Coverage Status
          - **Target:** 80% (warning threshold)
          - **Current:** ${coverage}%
          - **Status:** ${status}
          
          ---
          *Coverage reports are informational and do not block PRs.*
          *Generated using pytest-cov*`;
          
          // Find existing coverage comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.find(comment => 
            comment.body.includes('Coverage Report') && comment.user.login === 'github-actions[bot]'
          );
          
          if (existingComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }